Sub ExportOutlookContactsBatchWriteWithFix()
    Dim OutlookApp As Object
    Dim Namespace As Object
    Dim GAL As Object
    Dim AddressEntry As Object
    Dim user As Object
    Dim fso As Object
    Dim logFile As Object
    Dim rowNum As Long
    Dim NameParts() As String
    Dim FirstName As String, LastName As String, FullName As String
    Dim City As String, State As String, Country As String, ZipCode As String
    Dim JobTitle As String, Department As String, OfficeLocation As String
    Dim WorkPhone As String, Mobile As String
    Dim ManagerName As String, ManagerEmail As String, ManagerPhone As String, ManagerTitle As String
    Dim DirectReportsCount As Integer
    Dim DataArray() As Variant
    Dim count As Long, batchSize As Integer, totalRecords As Long
    Dim logFilePath As String, outputFilePath As String
    Dim xlApp As Object, xlBook As Object, xlSheet As Object
    
    ' Set log and output file paths
    logFilePath = "C:\Users\Public\Outlook_Export_Log.txt"
    outputFilePath = "C:\Users\Public\Outlook_GAL_Contacts.xlsx"
    
    ' Initialize File System Object for logging
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set logFile = fso.OpenTextFile(logFilePath, 8, True) ' Open in append mode
    
    ' Start logging
    logFile.WriteLine "Export started at: " & Now

    ' Initialize Outlook and Global Address List (GAL)
    On Error Resume Next
    Set OutlookApp = CreateObject("Outlook.Application")
    Set Namespace = OutlookApp.GetNamespace("MAPI")
    Set GAL = Namespace.AddressLists("Global Address List")
    On Error GoTo 0

    If OutlookApp Is Nothing Or GAL Is Nothing Then
        logFile.WriteLine "ERROR: Unable to access Outlook GAL."
        logFile.Close
        MsgBox "Error: Unable to access Outlook GAL. Check your Outlook settings.", vbCritical, "Outlook Error"
        Exit Sub
    End If

    ' Fix Overflow: Use Long instead of Integer
    totalRecords = CLng(GAL.AddressEntries.Count)
    
    ' Display Count in MsgBox
    MsgBox "Total records found in Global Address List: " & totalRecords, vbInformation, "GAL Record Count"

    ' Define batch size (write in chunks of 500 records)
    batchSize = 500
    ReDim DataArray(1 To batchSize, 1 To 18) ' Allocate memory for batch processing

    ' Create a new Excel file
    Set xlApp = CreateObject("Excel.Application")
    Set xlBook = xlApp.Workbooks.Add
    Set xlSheet = xlBook.Sheets(1)

    ' Write header row
    Dim Headers As Variant
    Headers = Array("Full Name", "First Name", "Last Name", "Email", "Job Title", "Department", "Office Location", _
                    "City", "State", "Country", "Zip Code", "Work Phone", "Mobile", _
                    "Manager Name", "Manager Email", "Manager Phone", "Manager Title", "Direct Reports Count")
    xlSheet.Range("A1:R1").Value = Headers

    ' Start processing contacts
    count = 0
    rowNum = 2 ' Start from row 2 in Excel

    ' Loop through all Address Entries
    For Each AddressEntry In GAL.AddressEntries
        If AddressEntry.AddressEntryUserType = 0 Then ' Ensure it's a user
            Set user = AddressEntry.GetExchangeUser()
            
            If Not user Is Nothing Then
                ' Extract Full Name and Handle Missing Last Name Cases
                FullName = Trim(user.Name)
                If FullName = "." Or FullName = "" Then FullName = "Unknown"

                ' Extract First Name & Last Name Properly
                NameParts = Split(FullName, " ")
                If UBound(NameParts) >= 1 Then
                    LastName = NameParts(UBound(NameParts))
                    If LastName = "." Then LastName = "Unknown"
                    FirstName = Trim(Left(FullName, Len(FullName) - Len(LastName)))
                Else
                    FirstName = FullName
                    LastName = "Unknown"
                End If

                ' Extract Job Title (Skip Record if Empty)
                On Error Resume Next
                JobTitle = user.JobTitle
                On Error GoTo 0
                If JobTitle = "" Or IsNull(JobTitle) Then
                    logFile.WriteLine "SKIPPED: " & FullName & " (No Job Title)"
                    GoTo SkipRecord
                End If

                ' Extract Other Fields
                On Error Resume Next
                Department = user.Department
                OfficeLocation = user.OfficeLocation
                WorkPhone = user.BusinessTelephoneNumber
                Mobile = user.MobileTelephoneNumber
                City = user.City
                State = user.State
                Country = user.Country
                ZipCode = user.ZipCode
                On Error GoTo 0

                ' Extract Manager Details
                On Error Resume Next
                ManagerName = user.Manager.Name
                ManagerEmail = user.Manager.PrimarySmtpAddress
                ManagerPhone = user.Manager.BusinessTelephoneNumber
                ManagerTitle = user.Manager.JobTitle
                If Err.Number <> 0 Then
                    ManagerName = "Permission Denied"
                    ManagerEmail = "Permission Denied"
                    ManagerPhone = "Permission Denied"
                    ManagerTitle = "Permission Denied"
                    logFile.WriteLine "WARNING: Manager details not accessible for " & FullName
                End If
                Err.Clear
                On Error GoTo 0

                ' Extract Direct Reports Count
                On Error Resume Next
                DirectReportsCount = 0
                For Each report In user.DirectReports
                    DirectReportsCount = DirectReportsCount + 1
                Next report
                On Error GoTo 0

                ' Store in Batch Array
                DataArray(count + 1, 1) = FullName
                DataArray(count + 1, 2) = FirstName
                DataArray(count + 1, 3) = LastName
                DataArray(count + 1, 4) = user.PrimarySmtpAddress
                DataArray(count + 1, 5) = JobTitle
                DataArray(count + 1, 6) = Department
                DataArray(count + 1, 7) = OfficeLocation
                DataArray(count + 1, 8) = City
                DataArray(count + 1, 9) = State
                DataArray(count + 1, 10) = Country
                DataArray(count + 1, 11) = ZipCode
                DataArray(count + 1, 12) = WorkPhone
                DataArray(count + 1, 13) = Mobile
                DataArray(count + 1, 14) = ManagerName
                DataArray(count + 1, 15) = ManagerEmail
                DataArray(count + 1, 16) = ManagerPhone
                DataArray(count + 1, 17) = ManagerTitle
                DataArray(count + 1, 18) = DirectReportsCount

                count = count + 1

                ' Write batch to Excel when batch size is reached
                If count = batchSize Then
                    xlSheet.Range("A" & rowNum).Resize(count, 18).Value = DataArray
                    rowNum = rowNum + count
                    count = 0
                    
                    ' Clear memory for the next batch
                    ReDim DataArray(1 To batchSize, 1 To 18)
                    logFile.WriteLine "Batch written. Taking a short delay..."
                    Application.Wait Now + TimeValue("00:00:02") ' 2-second delay
                End If
            End If
        End If
SkipRecord:
    Next AddressEntry

    ' Write remaining records
    If count > 0 Then xlSheet.Range("A" & rowNum).Resize(count, 18).Value = DataArray

    ' Save & Close Excel
    xlBook.SaveAs outputFilePath
    xlBook.Close False
    xlApp.Quit

    logFile.WriteLine "Export completed successfully!"
    logFile.Close
End Sub


# PowerShell script to extract Global Address List (GAL) data via Outlook
$OutputPath = "C:\Users\Public\GAL_Contacts.csv"

# Open Outlook COM object
$outlook = New-Object -ComObject Outlook.Application
$namespace = $outlook.GetNamespace("MAPI")
$gal = $namespace.AddressLists | Where-Object { $_.Name -eq "Global Address List" }

# Prepare CSV data
$contacts = @()
foreach ($entry in $gal.AddressEntries) {
    $user = $entry.GetExchangeUser()
    if ($user) {
        $contacts += [PSCustomObject]@{
            FullName = $user.Name
            Email = $user.PrimarySmtpAddress
            JobTitle = $user.JobTitle
            Department = $user.Department
            WorkPhone = $user.BusinessTelephoneNumber
            Mobile = $user.MobileTelephoneNumber
            OfficeLocation = $user.OfficeLocation
            Manager = if ($user.Manager) { $user.Manager.Name } else { "N/A" }
        }
    }
}

# Export to CSV
$contacts | Export-Csv -Path $OutputPath -NoTypeInformation
Write-Host "Export completed! Data saved to $OutputPath"

