import pandas as pd
import time
import random
import os
from exchangelib import Credentials, Account

# âœ… Define Common Base Path
BASE_PATH = "C:\\Users\\Public\\"

# âœ… Set File Paths
INPUT_FILE = os.path.join(BASE_PATH, "input_contacts.xlsx")  # âœ… Input Excel
OUTPUT_FILE = os.path.join(BASE_PATH, "input_contacts.xlsx")  # âœ… Overwrite same file
SKIP_LOG_FILE = os.path.join(BASE_PATH, "GAL_Skipped_Entries.log")

# âœ… Set your Exchange credentials
EMAIL = "your.email@company.com"
PASSWORD = "your_password"

# âœ… Connect to Exchange
try:
    print("Connecting to Exchange...")
    credentials = Credentials(EMAIL, PASSWORD)
    account = Account(EMAIL, credentials=credentials, autodiscover=True)
    print("âœ… Connected to Exchange successfully!")
except Exception as e:
    print(f"âŒ ERROR: Unable to connect to Exchange. {e}")
    exit()

# âœ… Function to log skipped entries with reason
def log_skipped(reason, user_data="N/A"):
    message = f"âš ï¸ Skipping entry: {reason} | Data: {user_data}"
    print(message)  # Print to console
    with open(SKIP_LOG_FILE, "a", encoding="utf-8") as log_file:
        log_file.write(message + "\n")  # Log to file

# âœ… Read emails from the input Excel file
try:
    df_input = pd.read_excel(INPUT_FILE)
    if "Author Email" not in df_input.columns:
        raise ValueError("âŒ ERROR: 'Author Email' column not found in Excel file.")
    email_list = df_input["Author Email"].dropna().unique().tolist()
    print(f"ğŸ“Œ Found {len(email_list)} unique emails to process.")
except Exception as e:
    print(f"âŒ ERROR: Unable to read input file. {e}")
    exit()

# âœ… Function to fetch the manager email for a given email address
def fetch_manager_email(email):
    """Fetch manager email from GAL for the given email address."""
    try:
        print(f"ğŸ” Fetching manager details for: {email} ...")
        time.sleep(random.uniform(0.5, 2))  # âœ… Add delay to prevent server overload

        resolved_names = account.protocol.resolve_names(email, return_full_contact_data=True)

        if not resolved_names:
            log_skipped("No GAL record found", email)
            return "N/A"

        for user in resolved_names:
            if isinstance(user, tuple) and len(user) >= 2:
                if hasattr(user[1], "manager") and user[1].manager:
                    manager_email = user[1].manager.email_address if hasattr(user[1].manager, "email_address") else "N/A"
                    return manager_email
                else:
                    log_skipped("Manager not found", email)
                    return "N/A"

        log_skipped("No valid GAL record found", email)
        return "N/A"

    except Exception as e:
        log_skipped(f"Unexpected error: {e}", email)
        return "N/A"

# âœ… Fetch manager email for each author email
df_input["Manager Email"] = df_input["Author Email"].apply(fetch_manager_email)

# âœ… Save the updated Excel file (Overwriting the original)
df_input.to_excel(OUTPUT_FILE, index=False, encoding="utf-8")

# âœ… Print execution summary
print(f"\nâœ… Export completed successfully! Manager emails added to {OUTPUT_FILE}")
print(f"ğŸ”¹ Total Records Processed: {len(df_input)}")
print(f"âš ï¸ Skipped entries logged in: {SKIP_LOG_FILE}")
